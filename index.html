<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Tool - No External Libs</title>
    <style>
        :root { --p: #2563eb; --s: #10b981; --d: #1e293b; --l: #f8fafc; }
        body { font-family: system-ui, sans-serif; background: #f1f5f9; padding: 20px; color: var(--d); line-height: 1.5; }
        .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--l); padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        h3 { margin-top: 0; font-size: 1.1rem; color: var(--p); }
        select, input, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; }
        .btn-gen { background: var(--d); color: white; font-weight: bold; cursor: pointer; border: none; padding: 15px; margin-top: 20px; font-size: 1.1rem; }
        .output-area { background: #0f172a; color: #10b981; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; margin-top: 20px; font-size: 1rem; }
        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn-midi { background: var(--s); color: white; border: none; cursor: pointer; font-weight: bold; }
        .btn-copy { background: #f59e0b; color: white; border: none; cursor: pointer; font-weight: bold; }
        .block-item { display: flex; align-items: center; gap: 5px; background: white; padding: 5px; margin-bottom: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .remove-btn { background: #ef4444; color: white; border: none; width: 30px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <header style="text-align: center; margin-bottom: 20px;">
        <h2 style="margin:0;">ðŸŽµ Chord Progression Tool</h2>
        <small>Standalone Version (No External Dependencies)</small>
    </header>

    <div class="grid">
        <div class="card">
            <h3>1. Einstellungen</h3>
            <label>Tonart & Skala</label>
            <div style="display:flex; gap:5px;">
                <select id="rootNote"><option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option></select>
                <select id="scaleType"><option value="major">Dur</option><option value="minor">Moll</option></select>
            </div>
            <label>Musikstil</label>
            <select id="genre">
                <option value="pop">Pop</option><option value="acoustic">Acoustic</option><option value="country">Country</option>
                <option value="edm">EDM</option><option value="funk">Funk</option><option value="hiphop">Hip-Hop</option><option value="rnb">RnB</option>
            </select>
            <label>KomplexitÃ¤t</label>
            <select id="complexity"><option value="1">DreiklÃ¤nge</option><option value="2">7th Chords</option><option value="3">9/11/13 Extensions</option></select>
        </div>
        <div class="card">
            <h3>2. Struktur</h3>
            <div id="structure-list"></div>
            <button onclick="addBlock()" style="background:#e2e8f0; border:none; color: #333; cursor:pointer;">+ Block hinzufÃ¼gen</button>
        </div>
    </div>

    <button class="btn-gen" onclick="generate()">Akkordfolge generieren</button>

    <div id="result-section" style="display:none;">
        <div id="output" class="output-area"></div>
       <!-- Suche diesen Bereich im HTML und ersetze ihn -->
        <div class="actions">
            <button class="btn-copy" onclick="copyText()">ðŸ“‹ Biab Text</button>
            <button class="btn-midi" onclick="exportMidi()">ðŸ’¾ Download MIDI</button>
            <!-- NEU: Der Drag-Button -->
            <div id="drag-handle" draggable="true" 
                 style="background: #6366f1; color: white; padding: 10px; border-radius: 6px; cursor: grab; font-weight: bold; flex-grow: 1; text-align: center; border: 2px dashed #4338ca;">
                 âž” DRAG TO ABLETON
            </div>
        </div>
    </div>
</div>

<script>
    // ... (Behalte die restlichen Variablen wie notes, scaleIntervals, genreRules, structure bei) ...

    let lastMidiBlobUrl = null;

    // --- DEINE BESTEHENDE GENERATE FUNKTION ---
    function generate() {
        // ... (Dein bisheriger Code fÃ¼r die Text-Generierung) ...
        
        // FÃ¼ge am Ende der generate() Funktion dies hinzu, 
        // um den Drag-Vorgang vorzubereiten:
        prepareDrag();
    }

    // --- NEUE FUNKTION: BEREITET DEN DRAG-VORGANG VOR ---
    function prepareDrag() {
        const dragHandle = document.getElementById('drag-handle');
        
        dragHandle.addEventListener('dragstart', (e) => {
            if (!lastProgression.length) {
                alert("Bitte erst generieren!");
                e.preventDefault();
                return;
            }

            // MIDI-Daten erzeugen
            const midiData = createMidi(lastProgression);
            const blob = new Blob([new Uint8Array(midiData)], {type: 'audio/midi'});
            
            // Falls schon eine URL existiert, lÃ¶schen (Speichermanagement)
            if (lastMidiBlobUrl) URL.revokeObjectURL(lastMidiBlobUrl);
            
            lastMidiBlobUrl = URL.createObjectURL(blob);
            const fileName = "progression.mid";
            
            // Der entscheidende Trick fÃ¼r den DAW-Drag:
            const downloadURL = `audio/midi:${fileName}:${lastMidiBlobUrl}`;
            e.dataTransfer.setData("DownloadURL", downloadURL);
            e.dataTransfer.setData("text/plain", fileName);
        });
    }

    // --- DEINE BESTEHENDE CREATE-MIDI FUNKTION ---
    function createMidi(prog) {
        const ticksPerQuarter = 480;
        let header = [0x4D, 0x54, 0x68, 0x64, 0x00, 0x00, 0x00, 0x06, 0x00, 0x00, 0x00, 0x01, 0x01, 0xE0];
        let trackData = [];
        trackData.push(0x00, 0xFF, 0x51, 0x03, 0x07, 0xA1, 0x20); // 120 BPM

        prog.forEach(chord => {
            let midiNotes = chord.offsets.map(o => chord.rootIdx + o + 48);
            midiNotes.forEach((n, i) => {
                trackData.push(i === 0 ? 0x00 : 0x00); 
                trackData.push(0x90, n, 0x60); 
            });
            let duration = ticksPerQuarter * 4; 
            trackData.push(...encodeVarInt(duration));
            midiNotes.forEach((n, i) => {
                trackData.push(i === 0 ? 0x00 : 0x00); 
                trackData.push(0x80, n, 0x00); 
            });
        });

        trackData.push(0x00, 0xFF, 0x2F, 0x00);
        let trackHeader = [0x4D, 0x54, 0x72, 0x6B, ...encodeLength(trackData.length)];
        return header.concat(trackHeader, trackData);
    }

    // Hilfsfunktionen (VarInt / Length) wie vorher...
    function encodeVarInt(v) {
        let buffer = [v & 0x7F];
        while (v >>= 7) buffer.push((v & 0x7F) | 0x80);
        return buffer.reverse();
    }
    function encodeLength(len) {
        return [(len >> 24) & 0xFF, (len >> 16) & 0xFF, (len >> 8) & 0xFF, len & 0xFF];
    }

    // ... (Der Rest deiner Funktionen: copyText, addBlock, renderStructure etc.) ...
</script>
</body>
</html>
