<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Tool - Ableton & Biab</title>
    <style>
        :root { --p: #2563eb; --s: #10b981; --d: #1e293b; --l: #f8fafc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f1f5f9; padding: 20px; color: var(--d); }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        header { text-align: center; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        h2 { margin: 0; color: var(--p); }

        .grid { display: grid; grid-template-columns: 1fr 1.3fr; gap: 25px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }

        .card { background: var(--l); padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; }
        h3 { margin-top: 0; font-size: 1.1rem; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 15px; }

        label { font-weight: bold; font-size: 0.85rem; display: block; margin-top: 10px; }
        select, input { padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; width: 100%; box-sizing: border-box; }

        /* Felder breit genug machen */
        .bars-input { width: 90px !important; text-align: center; font-weight: bold; }
        .block-select { width: 150px !important; font-weight: 600; cursor: pointer; border: 1px solid #cbd5e1 !important; background: white !important; }

        .block-item { display: flex; align-items: center; gap: 10px; background: white; padding: 10px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 6px; }

        .btn-gen { background: var(--d); color: white; font-weight: bold; cursor: pointer; border: none; padding: 15px; margin-top: 20px; width: 100%; border-radius: 8px; font-size: 1.1rem; transition: 0.2s; }
        .btn-gen:hover { background: #000; }

        .output-area { background: #0f172a; color: #10b981; padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; white-space: pre-wrap; margin-top: 20px; font-size: 1.1rem; border: 2px solid #334155; min-height: 120px; }

        .actions { display: none; gap: 15px; margin-top: 20px; }
        .btn-copy { background: #f59e0b; color: white; border: none; cursor: pointer; padding: 15px; border-radius: 8px; font-weight: bold; flex: 1; font-size: 1rem; }
        .btn-midi { background: var(--s); color: white; border: none; cursor: pointer; padding: 15px; border-radius: 8px; font-weight: bold; flex: 1; font-size: 1rem; }
        
        .remove-btn { background: #ef4444; color: white; border: none; width: 32px; height: 32px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        
        .workflow-hint { width: 100%; margin-top: 15px; background: #e0f2fe; color: #0369a1; padding: 10px; border-radius: 6px; font-size: 0.85rem; text-align: center; border: 1px solid #bae6fd; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>ðŸŽµ Chord Progression Tool</h2>
        <p style="margin:0; font-size: 0.9rem; color: #64748b;">Akkorde fÃ¼r Ableton Live & Band-in-a-Box</p>
    </header>

    <div class="grid">
        <div class="card">
            <h3>1. Einstellungen</h3>
            <label>Tonart & Skala</label>
            <div style="display:flex; gap:8px;">
                <select id="rootNote"><option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option></select>
                <select id="scaleType"><option value="major">Dur</option><option value="minor">Moll</option></select>
            </div>
            
            <label>Musikstil</label>
            <select id="genre">
                <option value="pop">Pop / Radio</option>
                <option value="acoustic">Acoustic / Songwriter</option>
                <option value="country">Country</option>
                <option value="edm">Electronic / EDM</option>
                <option value="funk">Funk</option>
                <option value="hiphop">Hip-Hop</option>
                <option value="rnb">RnB / Neo-Soul</option>
            </select>

            <label>KomplexitÃ¤t</label>
            <select id="complexity">
                <option value="1">DreiklÃ¤nge (Standard)</option>
                <option value="2">7th Chords (Jazz/Pop)</option>
                <option value="3">Complex (9/11/13 Extensions)</option>
            </select>
        </div>

        <div class="card">
            <h3>2. Songstruktur</h3>
            <div id="structure-list"></div>
            <button onclick="addBlock()" style="background:#e2e8f0; border:none; padding:10px; cursor:pointer; width:100%; border-radius:6px; font-weight:bold; margin-top:10px;">+ Block hinzufÃ¼gen</button>
        </div>
    </div>

    <button class="btn-gen" onclick="generate()">AKKORDFOLGE GENERIEREN</button>

    <div id="result-section">
        <div id="output" class="output-area" style="display:none;"></div>
        <div class="actions" id="action-buttons">
            <button class="btn-copy" onclick="copyText()">ðŸ“‹ BIAB TEXT KOPIEREN</button>
            <button class="btn-midi" onclick="exportMidi()">ðŸ’¾ MIDI DOWNLOAD</button>
        </div>
        <div id="workflow-hint" class="workflow-hint" style="display:none;">
            <b>Tipp:</b> Ziehe die heruntergeladene MIDI-Datei direkt aus der Download-Leiste deines Browsers in Ableton!
        </div>
    </div>
</div>

<script>
    const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const scaleIntervals = { major: [0, 2, 4, 5, 7, 9, 11], minor: [0, 2, 3, 5, 7, 8, 10] };
    const genreRules = {
        pop: { chords: ['I', 'IV', 'V', 'vi'], next: {'I':['IV','V','vi'], 'vi':['IV','V'], 'IV':['I','V'], 'V':['I']} },
        acoustic: { chords: ['I', 'ii', 'IV', 'V', 'vi'], next: {'I':['ii','vi','IV'], 'vi':['IV','V'], 'ii':['V'], 'IV':['I','V']} },
        country: { chords: ['I', 'IV', 'V'], next: {'I':['IV','V'], 'IV':['I','V'], 'V':['I']} },
        edm: { chords: ['i', 'VI', 'III', 'VII'], next: {'i':['VI'], 'VI':['III'], 'III':['VII'], 'VII':['i']} },
        funk: { chords: ['i', 'IV', 'v', 'bVII'], next: {'i':['IV','bVII'], 'IV':['i'], 'bVII':['i']} },
        hiphop: { chords: ['i', 'iv', 'v', 'VI'], next: {'i':['iv','VI'], 'iv':['v','i'], 'VI':['v']} },
        rnb: { chords: ['i7', 'ii7', 'IVmaj7', 'V7'], next: {'i7':['ii7','IVmaj7'], 'ii7':['V7'], 'V7':['i7']} }
    };

    // DEINE GEWÃœNSCHTE STRUKTUR
    let structure = [
        {type:'Intro', bars:4}, {type:'Verse', bars:8}, {type:'Prechorus', bars:8}, 
        {type:'Chorus', bars:8}, {type:'Bridge', bars:8}, {type:'Verse', bars:8}, 
        {type:'Chorus', bars:8}, {type:'Ending', bars:4}
    ];

    let lastProgression = [];

    function renderStructure() {
        const list = document.getElementById('structure-list');
        list.innerHTML = '';
        structure.forEach((b, i) => {
            const div = document.createElement('div');
            div.className = 'block-item';
            div.innerHTML = `
                <select class="block-select" onchange="structure[${i}].type=this.value">
                    <option ${b.type==='Intro'?'selected':''}>Intro</option>
                    <option ${b.type==='Verse'?'selected':''}>Verse</option>
                    <option ${b.type==='Prechorus'?'selected':''}>Prechorus</option>
                    <option ${b.type==='Chorus'?'selected':''}>Chorus</option>
                    <option ${b.type==='Bridge'?'selected':''}>Bridge</option>
                    <option ${b.type==='Ending'?'selected':''}>Ending</option>
                </select>
                <input type="number" class="bars-input" value="${b.bars}" min="1" onchange="structure[${i}].bars=parseInt(this.value)">
                <span style="font-size:13px; font-weight:bold;">T.</span>
                <div style="flex-grow:1"></div>
                <button class="remove-btn" onclick="structure.splice(${i},1);renderStructure()">Ã—</button>
            `;
            list.appendChild(div);
        });
    }

    function addBlock() { structure.push({type:'Verse', bars:8}); renderStructure(); }

    function getChord(num, root, scale, comp) {
        let rootIdx = notes.indexOf(root);
        let map = {'I':0,'ii':1,'iii':2,'IV':3,'V':4,'vi':5,'vii':6,'i':0,'III':2,'iv':3,'v':4,'VI':5,'VII':6,'bVII':6,'i7':0,'ii7':1,'IVmaj7':3,'V7':4};
        let step = map[num.replace('maj7','').replace('7','')] || 0;
        let noteIdx = (rootIdx + scaleIntervals[scale][step]) % 12;
        let offsets = [0, 4, 7]; let name = notes[noteIdx];
        if ((scale==='major' && [1,2,5].includes(step)) || (scale==='minor' && [0,3,4].includes(step))) { name += "m"; offsets = [0,3,7]; }
        if (comp >= 2) { 
            if(num.includes('maj') || (scale==='major' && [0,3].includes(step))) { name += "maj7"; offsets.push(11); }
            else { name += "7"; offsets.push(10); }
        }
        return { name, offsets, rootIdx: noteIdx };
    }

    function generate() {
        const gen = document.getElementById('genre').value;
        const root = document.getElementById('rootNote').value;
        const scale = document.getElementById('scaleType').value;
        const comp = document.getElementById('complexity').value;
        
        let txt = ""; lastProgression = [];
        structure.forEach(b => {
            txt += `[${b.type.toUpperCase()}]\n| `;
            let cur = genreRules[gen].chords[0];
            for(let i=0; i<b.bars; i++) {
                let c = getChord(cur, root, scale, comp);
                txt += c.name + " | "; lastProgression.push(c);
                let pool = genreRules[gen].next[cur] || genreRules[gen].chords;
                cur = pool[Math.floor(Math.random()*pool.length)];
            }
            txt += "\n\n";
        });

        document.getElementById('output').innerText = txt;
        document.getElementById('output').style.display = 'block';
        document.getElementById('action-buttons').style.display = 'flex';
        document.getElementById('workflow-hint').style.display = 'block';
    }

    function createMidiBytes(prog) {
        const tpq = 480;
        let header = [0x4D,0x54,0x68,0x64, 0x00,0x00,0x00,0x06, 0x00,0x00, 0x00,0x01, 0x01,0xE0];
        let track = [0x00, 0xFF, 0x51, 0x03, 0x07, 0xA1, 0x20];
        prog.forEach(chord => {
            let n = chord.offsets.map(o => chord.rootIdx + o + 48);
            n.forEach((note) => { track.push(0x00, 0x90, note, 0x60); });
            track.push(0x8F, 0x00); // 1 Bar
            n.forEach((note) => { track.push(0x00, 0x80, note, 0x00); });
        });
        track.push(0x00, 0xFF, 0x2F, 0x00);
        let len = [(track.length>>24)&0xFF, (track.length>>16)&0xFF, (track.length>>8)&0xFF, track.length&0xFF];
        return header.concat([0x4D, 0x54, 0x72, 0x6B], len, track);
    }

    function exportMidi() {
        const bytes = new Uint8Array(createMidiBytes(lastProgression));
        const blob = new Blob([bytes], {type: 'audio/midi'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "song_progression.mid";
        a.click();
    }

    function copyText() {
        const t = document.createElement('textarea');
        t.value = document.getElementById('output').innerText;
        document.body.appendChild(t); t.select();
        document.execCommand('copy'); document.body.removeChild(t);
        alert("Text kopiert fÃ¼r BiaB!");
    }

    window.onload = renderStructure;
</script>
</body>
</html>
