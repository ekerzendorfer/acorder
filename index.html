<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Generator Pro</title>
    
    <!-- Wir nutzen jetzt jsDelivr, einen der stabilsten Server weltweit -->
    <script src="https://cdn.jsdelivr.net/npm/midi-writer-js@2.1.4/browser/index.js"></script>
    
    <style>
        :root { --primary: #2563eb; --secondary: #10b981; --dark: #1e293b; --light: #f8fafc; }
        body { font-family: sans-serif; background: #f1f5f9; padding: 20px; color: var(--dark); }
        .container { max-width: 800px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: var(--light); padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        select, input, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
        .btn-gen { background: var(--dark); color: white; font-weight: bold; cursor: pointer; padding: 15px; margin-top: 20px; }
        .output-area { background: #0f172a; color: #10b981; padding: 15px; border-radius: 8px; font-family: monospace; white-space: pre-wrap; margin-top: 20px; }
        .btn-copy { background: #f59e0b; color: white; cursor: pointer; font-weight: bold; width: auto; padding: 10px 20px; }
        .btn-midi { background: var(--secondary); color: white; cursor: pointer; font-weight: bold; width: auto; padding: 10px 20px; }
        .block-item { display: flex; align-items: center; gap: 5px; background: white; padding: 5px; margin-bottom: 5px; border-radius: 5px; }
        .remove-btn { background: #ef4444; color: white; border: none; width: 25px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸŽµ Chord Progression Tool</h2>
    <div class="grid">
        <div class="card">
            <h3>Einstellungen</h3>
            <label>Tonart</label>
            <select id="rootNote"><option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option></select>
            <select id="scaleType"><option value="major">Dur</option><option value="minor">Moll</option></select>
            <label>Stil & KomplexitÃ¤t</label>
            <select id="genre">
                <option value="pop">Pop</option><option value="acoustic">Acoustic</option><option value="country">Country</option>
                <option value="edm">EDM</option><option value="funk">Funk</option><option value="hiphop">Hip-Hop</option><option value="rnb">RnB</option>
            </select>
            <select id="complexity"><option value="1">DreiklÃ¤nge</option><option value="2">7th Chords</option><option value="3">9/11/13</option></select>
        </div>
        <div class="card">
            <h3>Struktur</h3>
            <div id="structure-list"></div>
            <button onclick="addBlock()">+ Block</button>
        </div>
    </div>

    <button class="btn-gen" onclick="generate()">Akkordfolge generieren</button>

    <div id="result-section" style="display:none;">
        <div id="output" class="output-area"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn-copy" onclick="copyText()">ðŸ“‹ FÃ¼r Biab kopieren</button>
            <button class="btn-midi" onclick="exportMidi()">ðŸ’¾ MIDI fÃ¼r Ableton</button>
        </div>
    </div>
</div>

<script>
    const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const scaleIntervals = { major: [0, 2, 4, 5, 7, 9, 11], minor: [0, 2, 3, 5, 7, 8, 10] };
    const genreRules = {
        pop: { chords: ['I', 'IV', 'V', 'vi'], next: {'I':['IV','V','vi'], 'vi':['IV','V'], 'IV':['I','V'], 'V':['I']} },
        acoustic: { chords: ['I', 'ii', 'IV', 'V', 'vi'], next: {'I':['ii','vi','IV'], 'vi':['IV','V'], 'ii':['V'], 'IV':['I','V']} },
        country: { chords: ['I', 'IV', 'V'], next: {'I':['IV','V'], 'IV':['I','V'], 'V':['I']} },
        edm: { chords: ['i', 'VI', 'III', 'VII'], next: {'i':['VI'], 'VI':['III'], 'III':['VII'], 'VII':['i']} },
        funk: { chords: ['i', 'IV', 'v', 'bVII'], next: {'i':['IV','bVII'], 'IV':['i'], 'bVII':['i']} },
        hiphop: { chords: ['i', 'iv', 'v', 'VI'], next: {'i':['iv','VI'], 'iv':['v','i'], 'VI':['v']} },
        rnb: { chords: ['i7', 'ii7', 'IVmaj7', 'V7alt'], next: {'i7':['ii7','IVmaj7'], 'ii7':['V7alt'], 'V7alt':['i7']} }
    };

    let structure = [{type:'Intro', bars:4}, {type:'Verse', bars:8}, {type:'Prechorus', bars:8}, {type:'Chorus', bars:8}, {type:'Ending', bars:4}];
    let lastGenerated = [];

    function renderStructure() {
        const list = document.getElementById('structure-list'); list.innerHTML = '';
        structure.forEach((b, i) => {
            list.innerHTML += `<div class="block-item">
                <select onchange="structure[${i}].type=this.value" style="width:100px"><option ${b.type==='Intro'?'selected':''}>Intro</option><option ${b.type==='Verse'?'selected':''}>Verse</option><option ${b.type==='Prechorus'?'selected':''}>Prechorus</option><option ${b.type==='Chorus'?'selected':''}>Chorus</option><option ${b.type==='Bridge'?'selected':''}>Bridge</option><option ${b.type==='Ending'?'selected':''}>Ending</option></select>
                <input type="number" value="${b.bars}" style="width:40px" onchange="structure[${i}].bars=parseInt(this.value)">
                <button class="remove-btn" onclick="structure.splice(${i},1);renderStructure()">Ã—</button>
            </div>`;
        });
    }

    function addBlock() { structure.push({type:'Verse', bars:8}); renderStructure(); }

    function getChord(num, root, scale, comp) {
        let rootIdx = notes.indexOf(root);
        let step = {'I':0,'ii':1,'iii':2,'IV':3,'V':4,'vi':5,'vii':6,'i':0,'III':2,'iv':3,'v':4,'VI':5,'VII':6,'bVII':6}[num.replace('7','').replace('maj','').replace('alt','')] || 0;
        let noteIdx = (rootIdx + scaleIntervals[scale][step]) % 12;
        let name = notes[noteIdx];
        let offsets = [0, 4, 7];
        if ((scale==='major'&&[1,2,5].includes(step)) || (scale==='minor'&&[0,3,4].includes(step))) { name+="m"; offsets=[0,3,7]; }
        if (comp>=2) { name+=(num.includes('7')||num==='V')?"7":"maj7"; offsets.push(num.includes('maj')?11:10); }
        return { name, offsets, rootIdx: noteIdx };
    }

    function generate() {
        const gen = document.getElementById('genre').value;
        const root = document.getElementById('rootNote').value;
        const scale = document.getElementById('scaleType').value;
        const comp = document.getElementById('complexity').value;
        let txt = ""; lastGenerated = [];
        structure.forEach(b => {
            txt += `[${b.type.toUpperCase()}]\n| `;
            let cur = genreRules[gen].chords[0];
            for(let i=0; i<b.bars; i++) {
                let c = getChord(cur, root, scale, comp);
                txt += c.name + " | "; lastGenerated.push(c);
                cur = (genreRules[gen].next[cur] || genreRules[gen].chords)[0];
            }
            txt += "\n\n";
        });
        document.getElementById('output').innerText = txt;
        document.getElementById('result-section').style.display = 'block';
    }

    function copyText() {
        const area = document.createElement('textarea');
        area.value = document.getElementById('output').innerText;
        document.body.appendChild(area); area.select();
        document.execCommand('copy'); document.body.removeChild(area);
        alert("Kopiert!");
    }

    function exportMidi() {
        try {
            // Wir prÃ¼fen alle mÃ¶glichen Orte, wo die Library sein kÃ¶nnte
            const MW = window.MidiWriter || (typeof MidiWriter !== 'undefined' ? MidiWriter : null);
            if (!MW) throw new Error("MIDI Library nicht gefunden. Bitte Seite neu laden.");

            const track = new MW.Track();
            track.setTempo(120);

            lastGenerated.forEach(c => {
                const pitches = c.offsets.map(o => {
                    let n = notes[(c.rootIdx + o) % 12];
                    let oct = 3 + Math.floor((c.rootIdx + o) / 12);
                    return n + oct;
                });
                track.addEvent(new MW.NoteEvent({pitch: pitches, duration: '1'}));
            });

            const writer = new MW.Writer(track);
            const link = document.createElement('a');
            link.href = writer.dataUri();
            link.download = "progression.mid";
            link.click();
        } catch (e) { alert(e.message); }
    }

    renderStructure();
</script>
</body>
</html>
